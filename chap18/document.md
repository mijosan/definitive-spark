# 스파크 응급 처리

## 스파크 애플리케이션이 시작되지 않는 경우(주로 신규 클러스터 매니저나 환경을 사용하는 경우에 자주 발생)

### 징후와 증상
- 스파크 잡이 시작되지 않음
- 스파크 UI가 드라이버노드를 제외한 클러스터의 노드 정보를 전혀 표시하지 않음
- 스파크 UI가 잘못된 정보를 표시하는것 같음

### 원인 & 잠재적 대응법
- 주로 클러스터나 사용자 애플리케이션의 실행에 필요한 자원을 적절하게 설정하지 않았을때 발생
- 스파크 클러스터를 구축하는 과정에서 잘못된 설정을 했다면 드라이버와 익스큐터 간에 통신이 제대로 이루어지지 않을 수 있음
- IP를 잘못 입력했다거나 포트가 열려 있지 않은 경우에 발생 할 수 있음
- 대부분 클러스터 영역, 머신, 설정과 관련된 문제
- 사용자 애플리케이션에서 익스큐터 자원을 클러스터 매니저의 유휴 자원 이상으로 요청하는 경우 드라이버는 익스큐터가 실행될 때까지 무한정 대기한다
- 클러스터 매니저가 제공할 수 있는 메모리 자원 이상으로 익스큐터의 메모리 자원을 요청하는 경우가 자주 발생
- 클러스터간 설정한 포트로 통신할 수 있는지 확인
- 보안 요건이 엄격하지 않다면 워커 노드 간의 모든 포트를 여는 것이 좋음
- 스파크 자원 설정이 올바른지 확인 그런 다음 간단한 스파크 애플리케이션을 실행해 정상적으로 동작하는지 확인
- 클러스터 매니저의 UI로 유휴 자원을 확인한 다음 spark-submit 명령에 할당할 메모리를 설정


## 스파크 애플리케이션 실행 전에 오류가 발생한 경우(주로 새로운 애플리케이션을 개발해 클러스터에서 실행할 때 발생)


### 징후와 증상
- 명령이 전혀 실행되지 않으며 오류 메시지를 출력
- 스파크 UI에서 잡, 스테이지, 태스크의 정보를 확인할 수 없음

### 원인 & 잠재적 대응법
- 스파크 UI의 Environment 탭에서 애플리케이션 정보가 올바른지 확인한 다음 코드를 검토
- 단순한 오타나 잘못된 칼럼명을 사용하는 경우가 많으며 스파크 실행 계획(DataFrame)을 만드는 과정에서 오류가 발생(트랜스포메이션)
- 잘못된 입력 파일 경로나 필드명을 사용하는 것과 같이 코드상에 문제가 없는지 확인하기 위해 스파크가 반환하는 오류를 살펴야함
- 클러스터의 드라이버, 워커 그리고 사용하는 저장소 시스템 간의 네트워크 연결 상태를 다시 한번 확인
- 잘못된 버전의 저장소 접속용 라이브러리를 사용할 수 있으므로 라이브러리나 클래스패를 확인
- 이 문제가 재현될 때까지 사용자 애플리케이션의 로직을 하나씩 제거하면서 원인을 찾는다


## 스파크 애플리케이션 실행 중에 오류가 발생한 경우(이미 클러스터를 사용 중이거나 사용자 스파크 애플리케이션을 실행하는 중에 발생)

### 징후와 증상
- 하나의 스파크 잡이 전체 클러스터에서 성공적으로 실행되지만 다음 잡이 실패
- 여러 단계로 처리되는 쿼리의 특정 단계가 실패
- 어제 정상 동작한 예약 작업이 오늘은 실패
- 오류 메시지를 해석하기 어려움

### 원인 & 잠재적 대응법
- 데이터가 존재하는지, 데이터가 올바른 포맷인지, 일부처리 과정이 변경되어 의도하지 않는 결과를 초래 했을수 도 있음
- 만약 쿼리 실행 즉시 오류가 발생한다면(예: 태스크가 실행되기 전에 발생) 쿼리 실행 계획을 만드는 단계에서 발생한 분석 오류일 가능성이 높음. 즉 쿼리에 잘못된 칼럼명을 입력하였거나 칼럼, 뷰, 테이블이 존재하지 않을 수도 있음 (논리적 단계)
- 어떤 연산자와 스테이지가 실행 중이었는지 알아내기 위해 스택 트레이스를 분석해 단서를 찾아야함
- 애플리케이션의 코드를 조금씩 줄이면서 문제의 원인을 찾아본다
- 태스크가 비정상적으로 종료된다면 입력 데이터 자체의 문제 (스키마가 올바르게 지정되지 않았거나 특정 로우가 스키마 형태와 일치하지 않은 경우)일 수 있음(예: null값을 허용하지 않도록 스키마를 정의했지만 실제 데이터에 null 값이 있다면 특정 트랜스포메이션은 오류가 발생)
- 로그 파일을 분석해 오류 발생 시 어떤 작업이 진행 중이었는지 확인할 수 있으며 로그를 남기도록 코드를 추가해 처리 중인 데이터 레코드를 파악 해봐야함

